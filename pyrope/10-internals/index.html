
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../09-stdlib/">
      
      
        <link rel="next" href="../10b-vslang/">
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Internals - LiveHD and Pyrope</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/table.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#internals" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LiveHD and Pyrope" class="md-header__button md-logo" aria-label="LiveHD and Pyrope" data-md-component="logo">
      
  <img src="../../assets/pyrope5.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LiveHD and Pyrope
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Internals
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/masc-ucsc/livehd" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LiveHD and Pyrope" class="md-nav__button md-logo" aria-label="LiveHD and Pyrope" data-md-component="logo">
      
  <img src="../../assets/pyrope5.png" alt="logo">

    </a>
    LiveHD and Pyrope
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/masc-ucsc/livehd" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LiveHD and Pyrope
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Livehd
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Livehd
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/00-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/01-install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/02-usage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/03-memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memory and concurrency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/04-api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    C++ API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/05-lgraph/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LGraph
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/06-lnast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LNAST
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/10-bazel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bazel build
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/10b-3rdparty/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3rd Party
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/11-pass/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Creating a Pass
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/12-github/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GitHub Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/13-style/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coding Style
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Pyrope
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Pyrope
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../00-hwdesign/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Hardware Design
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../01-introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../02-basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic syntax
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../03-bundle/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tuples
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../04-variables/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Variables and types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05-assert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Verification
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../05b-statements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Statements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06-functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lambdas
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06b-instantiation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Instantiation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../06c-pipelining2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipelining
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07-typesystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Type system
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../07b-structtype/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Structural Typing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../08-memories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Memories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../09-stdlib/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pyrope std lib
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Internals
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Internals
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tuple-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tuple operations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#determinism" class="md-nav__link">
    <span class="md-ellipsis">
      
        Determinism
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Determinism">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#import" class="md-nav__link">
    <span class="md-ellipsis">
      
        Import
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Register reference
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-unknowns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dealing with unknowns
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimize-directive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimize directive
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unknown-no-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unknown no optimization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lnast-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        LNAST optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LNAST optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type-synthesis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type synthesis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#programming-warts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Programming warts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Programming warts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shadowing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shadowing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#closures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Closures
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lambda arguments
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-tuples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple tuples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unknowns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unknowns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        for loop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-bit-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple bit selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unexpected-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unexpected calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-is-an-expression" class="md-nav__link">
    <span class="md-ellipsis">
      
        if is an expression
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#legal-but-weird" class="md-nav__link">
    <span class="md-ellipsis">
      
        Legal but weird
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../10b-vslang/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    vs Other Languages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11-deprecated/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deprecated or Future
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../11b-deprecated_pipelining/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deprecated Pipelining
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../12-lnast/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    LNAST
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../13-stdlib/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pyrope Standard Library
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14a-small_pyrope/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Small Pyrope - Minimal Hardware Description Language
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14b-small_pyrope_todo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Small Pyrope â€“ TODO Features
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../14c-small_pyrope_summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Small Pyrope - Summary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_24" >
        
          
          <label class="md-nav__link" for="__nav_3_24" id="__nav_3_24_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Node modules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_24_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_24">
            <span class="md-nav__icon md-icon"></span>
            
  
    Node modules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_24_1" >
        
          
          <label class="md-nav__link" for="__nav_3_24_1" id="__nav_3_24_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    @openai
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_24_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_24_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    @openai
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_24_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../node_modules/%40openai/codex/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Codex
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="4" aria-labelledby="__nav_3_24_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_24_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Codex
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_25" >
        
          
          <label class="md-nav__link" for="__nav_3_25" id="__nav_3_25_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Old
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_25_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_25">
            <span class="md-nav__icon md-icon"></span>
            
  
    Old
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../old/small_pyrope_flow/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Small pyrope flow
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tuple-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tuple operations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#determinism" class="md-nav__link">
    <span class="md-ellipsis">
      
        Determinism
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Determinism">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#import" class="md-nav__link">
    <span class="md-ellipsis">
      
        Import
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#register-reference" class="md-nav__link">
    <span class="md-ellipsis">
      
        Register reference
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dealing-with-unknowns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Dealing with unknowns
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimize-directive" class="md-nav__link">
    <span class="md-ellipsis">
      
        Optimize directive
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unknown-no-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unknown no optimization
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lnast-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      
        LNAST optimization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LNAST optimization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#type-synthesis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Type synthesis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#programming-warts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Programming warts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Programming warts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#shadowing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Shadowing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#closures" class="md-nav__link">
    <span class="md-ellipsis">
      
        Closures
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      
        Lambda arguments
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-tuples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple tuples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unknowns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unknowns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#for-loop" class="md-nav__link">
    <span class="md-ellipsis">
      
        for loop
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-bit-selection" class="md-nav__link">
    <span class="md-ellipsis">
      
        Multiple bit selection
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#unexpected-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Unexpected calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#if-is-an-expression" class="md-nav__link">
    <span class="md-ellipsis">
      
        if is an expression
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#legal-but-weird" class="md-nav__link">
    <span class="md-ellipsis">
      
        Legal but weird
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="internals">Internals<a class="headerlink" href="#internals" title="Permanent link">&para;</a></h1>
<p>This section of the document provides a series of disconnected topics about the
compiler internals that affects semantics.</p>
<h2 id="tuple-operations">Tuple operations<a class="headerlink" href="#tuple-operations" title="Permanent link">&para;</a></h2>
<p>There are 3 basic operations/checks with tuples that affect many other
operations: <code>a in b</code>, <code>a does b</code>, and lambda call rules.</p>
<ul>
<li>
<p><code>a in b</code> allows to work when <code>b</code> is a name/unnamed tuple even when <code>a</code> is named.</p>
</li>
<li>
<p><code>a does b</code> requires <code>b</code> to be named consistent with names in <code>a</code>.</p>
</li>
<li>
<p>lambda call matches the arguments with the definition in a third different set of rules.</p>
</li>
</ul>
<div class="highlight"><pre><span></span><code>cassert (a=1) in (1,a=1,3)
cassert (a=1) !does (1,a=1,3)

const f = comb(a) { puts &quot;{a}&quot; }
const g = comb(long, short) { puts &quot;{long}&quot; }

f(a=1)             // OK
f(1)               // OK

g(long=1, short=1) // OK
g(1,1)             // compile error
const long=1
g(long, short=1)   // OK
const short=1
g(long, short)     // OK
</code></pre></div>
<p>Operators like <code>a == b</code>, <code>a case b</code>, <code>a equals b</code>, ... built on top of the previous functionality.</p>
<h2 id="determinism">Determinism<a class="headerlink" href="#determinism" title="Permanent link">&para;</a></h2>
<p>Pyrope is designed to be deterministic. This means that the result is always
the same for synthesis. Simulation is also deterministic unless the random seed
is changed or non-Pyrope (C++) calls to <code>procedures</code> add non-determinism.</p>
<p>Expressions are deterministic because <code>procedures</code> have an explicit order in
Pyrope. Only <code>functions</code> have a non-explicit order, but <code>functions</code> are pure
without side-effects. <code>puts</code> can be called non-deterministically but the result
is buffered and ordered at the end of the cycle to be deterministic.</p>
<p>The only source of non-determinism is non-Pyrope (C++) calls from <code>procedures</code>
executed at different pipeline stages. The pipeline stages could be executed in
any order, it is just that the same order must be repeated deterministically
during simulation. The non-Pyrope calls must be <code>::[comptime] == true</code> to affect
synthesis. So the synthesis is deterministic, but the testing like cosimulation
may not.</p>
<p>The same non-Pyrope calls also represent a problem for the compiler
optimizations. During the setup phase, several non-Pyrope can exist like
reading the configuration file. If the non-Pyrope calls are not deterministic,
the result could be a non-deterministic setup phase.</p>
<p>The idea is that the non-Pyrope API is also divided in 2 categories:
<code>functions</code> and <code>procedures</code>. A <code>function</code> can be called many times without
non-Pyrope side-effects. Pyrope guarantees that the <code>procedures</code> are called in
the same order given a source code, but does not guarantee the call order. This
guarantee order slowdowns simulation and elaboration. Whenever possible, use
<code>functions</code> instead of <code>procedures</code> for compilation speed reasons.</p>
<h3 id="import">Import<a class="headerlink" href="#import" title="Permanent link">&para;</a></h3>
<p><code>import</code> statement allows for circular dependencies of files, but not of
variables. This means that if there is no dependency (<code>a imports b</code>), just
running <code>a</code> before <code>b</code> is enough. If there is a dependency (<code>a imports b</code> and <code>b
imports a</code>) a multiple compiler pass is proposed, but other solutions are
allowed as long as it can handle not true circular dependences.</p>
<p>The solution to this problem is to pick an order, and import at least three
times the files involved in the cyclic dependency. The files involved in the
cylic dependency are alphabetically sorted and called three times: (1) <code>a
import b</code>, then <code>b import a</code>; (2) <code>a import b</code> and <code>b import a</code>; (3) <code>a import
b</code> and <code>b import a</code>. Only the last import chain can perform procedure <code>proc</code>
calls (Pyrope and non-Pyrope) and puts/debug statements.</p>
<p>If the result of the last two imports has the same variables, the import has
"converged", otherwise a compile error is generated. This multi-pass solution
does not address all the false paths, but the common case of having two sets of
independent variables. This should address most of the Pyrope cases because
there is no concept of "reference/pointer" which is a common source of
dependences.</p>
<h3 id="register-reference">Register reference<a class="headerlink" href="#register-reference" title="Permanent link">&para;</a></h3>
<p>Register reference (<code>regfef</code>) can create a dependence update between files, but this is
not a source of non-determinism because only one file can perform updates for
the register <code>din</code> pin, and all the updated register can only read the register
<code>q</code> pin.</p>
<h2 id="dealing-with-unknowns">Dealing with unknowns<a class="headerlink" href="#dealing-with-unknowns" title="Permanent link">&para;</a></h2>
<p>Pyrope tries to be compatible with synthesizable Verilog but not equivalent. As
such it must handle/understand unknowns. Compatible does not mean that it will
generate the same <code>?</code> bits as Verilog, but that it will not generate an unknown
when Verilog has known. It is allowed to generate a <code>0</code> or a <code>1</code> when the
Verilog logical equivalence check generates an <code>?</code>.</p>
<p>An example of different behavior is that Verilog semantics state <code>0 * 0sb?</code> is
<code>0sb?</code> while most programmers would expect a zero.</p>
<p>The previous definition of compatibility could allow the Pyrope compiler to
randomly replace all the unknowns by <code>0</code> or <code>1</code> when doing internal compiler
passes. This is not done at compile time to keep determinism, but simulation
time should randomly pick 0/1 for unknown bits.</p>
<p>The issue is that the most likely source of having unknowns in operations is
either during reset or due to a bug on how to handle non initialized structures
like memories.</p>
<p>The compiler internal transformations use a 3-state logic that includes <code>0</code>,
<code>1</code>, and <code>?</code> for each bit. Any register or memory initialized with unknowns
will generate a Verilog with the same initialization.</p>
<p>The compiler internals only needs to deal with unknowns during the copy
propagation or peephole optimizations. The compile goes through 2 phases: LNAST
and Lgraph.</p>
<p>In the compiler passes, we have the following semantics:</p>
<ul>
<li>
<p>In Pyrope, there are 3 array-like structures: non-persistent arrays, register
  arrays, and custom RTL memories. Verilog and CHISEL memories get translated
  to custom RTL memories. Non-persistent Verilog/CHISEL get translated to arrays.
  In Verilog, the semantics is that an out of bounds access generates unknowns. In
  CHISEL, the <code>Vec</code> is that an out of bound access uses the first index
  of the array. A CHISEL out of bound memory is an unknown like in Verilog. These
  are the semantics applied by the compiler optimization/transformations:</p>
<ul>
<li>
<p>Custom RTL memories do not allow value propagation across the array, only
  across non-persistent arrays, or register arrays explicitly marked with
  <code>retime=true</code>.</p>
</li>
<li>
<p>An out of bound RTL address drops the unused index bits. For non-power of
  two arrays, out of bounds access triggers a compile error. The code must
  be fixed to avoid access. An <code>if addr &lt; mem_size { ... mem[addr] ... }</code>
  tends to be enough. This is to guarantee that passes like Verilog and
  CHISEL have the same semantics, and trigger likely bugs in Pyrope code.</p>
</li>
<li>
<p>An index with unknowns does not perform value propagation.</p>
</li>
</ul>
</li>
<li>
<p>Shifts, additions and substractions propagate unknowns at computation. E.g:
  <code>0b11?0 + 0b1</code> is <code>0b11?1</code>, <code>0b1?0 &gt;&gt; 1</code> is <code>0b1?</code>.</p>
</li>
<li>
<p>Other arithmetic are more conservative. When an input is unknown, the result
  is unknown only respecting the sign when possible. E.g: <code>0b1?0? * -1</code> is
  <code>0sb1?</code>.</p>
</li>
<li>
<p>Logic operations behave like Verilog. <code>0b000111??? | 0b01?01?01?</code> is
  <code>0b01?111?1?</code>.</p>
</li>
<li>
<p>Equality comparisons (<code>==</code> and <code>!=</code>) use unknowns, this means that at compile
  time <code>0b1? != 0b10</code>. Comparisons is consistent with the equivalent logic
  operations <code>a == b</code> is the same as <code>(a ^ b) == -1</code>.</p>
</li>
<li>
<p>Other comparisons (<code>&lt;=</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&gt;=</code>) return true if the comparison is
  true for each possible unknown bit.</p>
</li>
<li>
<p><code>match</code> statement and <code>unique if</code> will trigger a compile error if the unknown
  semantics during compiler passes can trigger 2 options simultaneously. The
  solution is to change to a sequence of <code>ifs</code> or change the code to guarantee
  no unknowns.</p>
</li>
<li>
<p><code>if</code> statement without <code>unique</code> logical expressions that have an unknown
  (single bit) are a source of confusion. In Verilog, it depends on the
  compiler options. A classic compiler will generate <code>?</code> in all the updated
  variables.  A Tmerge option will propagate <code>?</code> only if both sides can
  generate a different value. The LNAST optimization pass will behave like the
  Tmerge when the if/mux control has unknowns:</p>
<ul>
<li>
<p>If all the paths have the same constant value, the <code>if</code> is useless and
  the correct value will be used.</p>
</li>
<li>
<p>If any path has a different constant value, the generated result bits will
  have unknowns if the source bits are different or unknown.</p>
</li>
<li>
<p>If any paths are not constant, there is no LNAST optimization. Further
  Lgraph optimizations could optimize if all the mux generated values are
  proved to be the same.</p>
</li>
</ul>
</li>
<li>
<p>The <code>for</code> loops are expanded, if the expression in the <code>for</code> is unknown, a
  compile error is generated.</p>
</li>
<li>
<p>The <code>while</code> loops are also expanded, if the condition on the <code>while</code> loop has
  unknowns a compile error is generated.</p>
</li>
</ul>
<p>At the end of the LNAST generation, a Lgraph is created. Only the registers and
memory initialization are allowed to have unknowns in Lgraph.  Any invalid
(<code>nil</code>) assigned to an output or register triggers a compile error. Any unknown constant
bit is translated preserved (<code>0b10?</code>).</p>
<p>The semantics on the generated simulator are similar to CHISEL, any unknowns
are randomly translated to 0 or 1 at initialization.</p>
<h2 id="optimize-directive">Optimize directive<a class="headerlink" href="#optimize-directive" title="Permanent link">&para;</a></h2>
<p>The <code>optimize</code> directive is like an <code>assert</code> but it also allows compiler
optimizations. In a way, it is a safer version of Verilog <code>?</code>. Unlike other
languages like C++23, Pyrope <code>optimize</code> verifies at simulation time that the
<code>optimize</code> is correct. This means that the <code>optimize</code> is checked like an
<code>assert</code> but it allows the compiler to optimize based on the condition.
<code>asserts</code> do not trigger optimizations because their check can be disabled at
simulation time, and hence create mismatches between simulation and synthesis
if the compiler optimized over assertions.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Verilog x-optimization</label><label for="__tabbed_1_2">Pyrope <code>match</code></label><label for="__tabbed_1_3">Generated Logic 1 bit f</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">always_comb</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// one hot mux</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="p">(</span><span class="n">sel</span><span class="p">)</span>
<span class="w">    </span><span class="mh">3</span><span class="err">â€™</span><span class="n">b001</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">f</span><span class="o">=</span><span class="n">i0</span><span class="p">;</span>
<span class="w">    </span><span class="mh">3</span><span class="err">â€™</span><span class="n">b010</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">f</span><span class="o">=</span><span class="n">i1</span><span class="p">;</span>
<span class="w">    </span><span class="mh">3</span><span class="err">â€™</span><span class="n">b100</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">f</span><span class="o">=</span><span class="n">i2</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="n">f</span><span class="o">=</span><span class="mh">2</span><span class="err">â€™</span><span class="n">b</span><span class="o">??</span><span class="p">;</span>
<span class="w">  </span><span class="k">endcase</span>
<span class="k">end</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>optimize sel==1 or sel==2 or sel==4 // not needed. match sets it
match sel {
  == 0b001 { f = i0 }
  == 0b010 { f = i2 }
  == 0b100 { f = i3 }
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>f = (sel[0] &amp; i0)
  | (sel[1] &amp; i1)
  | (sel[2] &amp; i2)
</code></pre></div>
</div>
</div>
</div>
<p>Optimize allows more freedom, without dangerous Verilog x-optimizations:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Bad Verilog x-optimization</label><label for="__tabbed_2_2">Pyrope optimize</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0</span><span class="p">)</span><span class="w"> </span><span class="k">begin</span>
<span class="w">   </span><span class="n">assert</span><span class="p">(</span><span class="n">false</span><span class="p">);</span>
<span class="w">   </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&#39;</span><span class="o">?</span><span class="p">;</span>
<span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mh">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">1</span><span class="w"> </span><span class="k">begin</span><span class="w"> </span><span class="c1">// always false</span>
<span class="w">   </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">1</span><span class="p">;</span>
<span class="k">end</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">begin</span>
<span class="w">   </span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">3</span><span class="p">;</span>
<span class="k">end</span>

<span class="n">array</span><span class="p">[</span><span class="mh">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&#39;</span><span class="o">?</span><span class="p">;</span><span class="w"> </span><span class="c1">// entry 3 will not be used</span>
<span class="c1">// array = (1,2,3,&#39;?,5,6,7,8)</span>
<span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">array</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>optimize a != 0


if (1 + a) != 1 { // always false
  out = 1
}else{
  out = 3
}

optimize b != 3
// array = (1,2,3,4,5,6,7,8)
res = array[b]
</code></pre></div>
</div>
</div>
</div>
<h2 id="unknown-no-optimization">Unknown no optimization<a class="headerlink" href="#unknown-no-optimization" title="Permanent link">&para;</a></h2>
<p>In Verilog, unknowns can trigger synthesis optimizations. This is not the case
in Pyrope. Each unknown bit (<code>?</code>) can result in random 0/1 at simulation time, but it will
not trigger optimizations. The <code>optimize</code> statement should be use for such behavior.</p>
<div class="highlight"><pre><span></span><code>assert cond==3     // Not cassert or optimize, so no optimized
mut x1 = 0sb?

if cond == 3 {
  x1 = 1
}
assert  x1==1 // still not optimized (cassert fails)
assert !x1 and x1::[comptime] == true

mut x2 = 0sb?
optimize cond==3
if cond == 3 {
  x2 = 1
}
cassert x2==1
cassert x2::[comptime] == true
</code></pre></div>
<h2 id="lnast-optimization">LNAST optimization<a class="headerlink" href="#lnast-optimization" title="Permanent link">&para;</a></h2>
<p>The compiler has three IR levels: The high level is the parse AST, the
mid-level is the LNAST, and the low level is the Lgraph. This section explains
the main steps in the LNAST optimizations/transformations before performing
type synthesis and generating the lower level Lgraph. This is a minimum of
optimizations without them several type conflicts would be affected.</p>
<p>Unlike the parse AST, the LNAST nodes are guaranteed to be in topological
order. This means that a single pass that visits the children first (deep
first) is sufficient.</p>
<p>The work can be performed as a single "global" topographical pass starting from
the root/top, where each LNAST node performs these operations during traversal
depending on the LNAST node:</p>
<ul>
<li>
<p>If the node allows, perform these node input optimization first:</p>
<ul>
<li>
<p>constant folding for existing node, also be performed as instruction
  combining proceeds</p>
</li>
<li>
<p>instruction combining from sources only for same type but not beyond 128
  n-ary nodes. This step subsumes constant propagation and copy
  propagation. E.g: <code>a+(x-3)+1</code> becomes <code>a+x-3+1</code></p>
</li>
<li>
<p>create a canonical order by sorting the inputs by name/constant. E.g: <code>+
  2 a b</code>. This simplifies the following steps but it is not needed for
  semantics. Most commutative gates (<code>add/sub/and/or/...</code>) will have a
  single constant as a result.</p>
</li>
<li>
<p>trivial simplification with constants for existing node, also performed
  as instruction combining proceeds. E.g.: <code>a+0 == a</code>, <code>a or true
  == true</code> ...</p>
</li>
<li>
<p>trivial identity simplification for existing node, also performed as
  instruction combining proceeds. E.g: <code>a^a == a</code>, <code>a-a=0</code> ...</p>
</li>
</ul>
</li>
<li>
<p>If the node is a <code>::[comptime] == true</code> trigger a compile error unless all the inputs are
  constant</p>
<ul>
<li><code>cassert</code> should satisfy the condition or a compile error is generated</li>
</ul>
</li>
<li>
<p>If the node is a loop (<code>for</code>/<code>while</code>) that has at least one iteration expand
  the loop. This is an iterative process because the loop exit condition may
  depend on the loop body or functions called inside. After the loop
  expansions, no <code>for</code>, <code>while</code>, <code>break</code>, <code>last</code>, <code>continue</code> statement
  exists.</p>
</li>
<li>
<p>If the node is a function call, iterate over the possible polymorphic calls.
  Call the first call that is valid (input types). Call the function and pass
  all the input constants needed. This requires specializing the function
  by input constants and types. If no call matches a valid type trigger a
  compile error</p>
</li>
<li>
<p>Delete unreachable statements (<code>if false { delete his }</code>, <code>delete this when false</code>, ...)</p>
</li>
<li>
<p>Compute these steps that may be needed in future steps:</p>
<ul>
<li>
<p>Perform the "Mark" phase typical in dead-code-elimination (DCE) so that
  dead nodes are not generated when creating the Lgraph.</p>
</li>
<li>
<p>Update the tuple field in the Symbol Table</p>
</li>
<li>
<p>Track the array accesses for memory/array Lgraph generation</p>
</li>
</ul>
</li>
</ul>
<h3 id="type-synthesis">Type synthesis<a class="headerlink" href="#type-synthesis" title="Permanent link">&para;</a></h3>
<p>The type synthesis and check are performed during the LNAST pass. Pyrope uses a
structural type system with global type inference.</p>
<p>The type inference should be performed as the same time as the LNAST
optimization traverses the tree. It can not be a separate pass because there
can be interactions between the LNAST optimization and the Type synthesis.
These are the additional checks performed for type synthesis:</p>
<ul>
<li>
<p>If the node does type checks (<code>equals</code>, <code>does</code>) compute the outcome and
  perform copy propagation. The result of this step is that the compiler is
  effectively doing flow-type inference. All the types must be resolved before.
  If the <code>equals</code>/<code>does</code> was in a <code>if</code> condition, the control is decided at
  compile time.</p>
</li>
<li>
<p>If the node reads bitwidth, replace the node with the computer Bitwidth value
  (max, min, ubits, and/or sbits)</p>
<ul>
<li>Compute the max/min for the output[s] using the bitwidth algorithm.
  Update the symbol table with the range. This is only needed because some
  code like polymorphism functions can read the bits.</li>
</ul>
</li>
<li>
<p>If the node is a conditional (<code>if</code>/<code>match</code>), the pass performs narrowing<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup>.</p>
<ul>
<li>
<p>When the expression has these possible syntax <code>v &gt;= y</code>, <code>v &gt;
  y</code> or the reciprocals, restrict the Bitwidth. E.g: in the <code>v &lt; y</code>
  restricts the <code>v.max = y.min-1 ; y.min = v.min + 1</code></p>
</li>
<li>
<p>When the expression is an equality format <code>eq [and eq]*</code> or <code>eq [or
  eq]*</code> like <code>v1 == z1 and v2 != z2</code>, create a <code>v1=z1</code> and <code>v2=z2</code> in the
  corresponding path. This will help bitwidth and copy propagation.
  Complicated mixes of and/or have no path optimization</p>
</li>
<li>
<p>When the expression is a single variable <code>a</code> or <code>!a</code>, set the variable
  <code>true</code> and <code>false</code> in both paths</p>
</li>
</ul>
</li>
</ul>
<p>No previous transformation could break the type checks. This means that the
copy propagation, and final lgraph translation the type checks are respected.</p>
<ul>
<li>
<p>All the entries on the comparator have the same type (<code>LHS equals RHS</code>)</p>
</li>
<li>
<p>Left side assignments respect the assigned type (<code>LHS does RHS</code>)</p>
</li>
<li>
<p>Any explicit type on any expression should respect the type (<code>mut does type</code>)</p>
</li>
</ul>
<p>The previous algorithm describes the semantics, the implementation may be
different.  For example, to parallelize the algorithm, each LNAST tree can be
processed locally, and then a global top pass is performed.</p>
<h2 id="programming-warts">Programming warts<a class="headerlink" href="#programming-warts" title="Permanent link">&para;</a></h2>
<p>In programming languages, warts are small code fragments that have unexpected
or not great behavior. Every language has its warts. This section tries to list
the Pyrope main ones to address and learn more about the language.</p>
<h3 id="shadowing">Shadowing<a class="headerlink" href="#shadowing" title="Permanent link">&para;</a></h3>
<p>Pyrope does not allow shadowing, but you can still have it with tuples. To
access the tuple field, the <code>self.field</code> is always required. This avoid the
problem of true shadowing.</p>
<div class="highlight"><pre><span></span><code>const f1 = comb() { 1 }

const tup = (
  f1 = comb() { 2 },
  code = comb() {
     assert self.f1() == 2
     assert f1() == 1
  }
)
</code></pre></div>
<h3 id="closures">Closures<a class="headerlink" href="#closures" title="Permanent link">&para;</a></h3>
<p>Closures capture extra state or inputs at definition. The capture variables are
always immutable <code>let</code> no matter the outter scope definition. Therefore,
capture variables behave like passed by value, not reference.</p>
<p>One important thing is 'when' does the capture happens. Pyrope follows the
model of most languages like C++ that captures at lambda definition, not lambda
execution.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Pyrope capture time</label><label for="__tabbed_3_2">C++17 capture time</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>mut x_s = 10

const call_captured = fun[x_s]() {
  fun[x_s]() {
    assert x_s == 10
    x_s
  }
}

test &quot;capture test&quot; {
  const tst = comb() {
    mut x_s = 20   // not variable shadowing because fun scope

    const x1 = call_captured()
    assert x1 == 10

    x_s = 30;

    const x2 = call_captured()
    assert x2 == 10
  }
  tst // call the test
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">x_s</span><span class="p">{</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">};</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">call_captured</span><span class="p">{</span>
<span class="w">    </span><span class="p">[</span><span class="n">x_s</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="n">x_s</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">x_s</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">x_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">x1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_captured</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">x1</span><span class="o">==</span><span class="mi">10</span><span class="p">);</span>

<span class="w">  </span><span class="n">x_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">x2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">call_captured</span><span class="p">();</span>
<span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="n">x2</span><span class="o">==</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>Some languages like ZIG do not allow closures, but they allow structs with a lambda to
implement an equivalent functionality. It is possible in Pyrope to also create a tuple
and populate the getter. This effectively behaves as the closures. Internally, Pyrope
may do this implementation.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Pyrope tuple closure style</label><label for="__tabbed_4_2">ZIG closure style with struct</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>const j = 1
const b = fun[j](x:i32) -&gt; (result:i32) {
  result = x + j
}

assert b(1) == 2

test &quot;closure with tuple&quot; {
  mut a: i32 = 1
  a += 1

  mut addX = (
    a:i32 = a,                        // copy value, runtime or comptime
    getter = comb(self, x:i32) {
      x + self.a
    }
  )

  a += 100;

  assert addX(2) == 4
}

test &quot;plain closure&quot; {
  mut a:i32 = 1
  a += 1

  const addX = fun[a](x:i32) { // Same behaviour as closure with tuple
    x + a
  }

  a += 100;

  assert addX(2) == 4
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><span class="kr">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kr">const</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="n">mut</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">struct</span><span class="p">{</span>
<span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}.</span><span class="n">function</span><span class="p">;</span>

<span class="w">    </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">).</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">test</span><span class="w"> </span><span class="s">&quot;closure with runtime&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">mut</span><span class="w"> </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">  </span><span class="kr">const</span><span class="w"> </span><span class="n">addX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">a</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="n">call</span><span class="p">(</span><span class="n">self</span><span class="o">:</span><span class="w"> </span><span class="nb">@This</span><span class="p">(),</span><span class="w"> </span><span class="n">x</span><span class="o">:</span><span class="w"> </span><span class="kt">i32</span><span class="p">)</span><span class="w"> </span><span class="kt">i32</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">a</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">.</span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">}).</span><span class="n">call</span><span class="p">;</span>

<span class="w">  </span><span class="n">a</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">  </span><span class="nb">@import</span><span class="p">(</span><span class="s">&quot;std&quot;</span><span class="p">).</span><span class="n">debug</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">addX</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</div>
</div>
</div>
<p>Capture values must be explicit, or no capture happens. This means that
<code>...fun[](...)...</code> is the same as <code>...fun(...)...</code>.</p>
<div class="highlight"><pre><span></span><code>mut x = 3

const f1 = fun[x]() -&gt; (result:int) {
   assert x == 3
   mut x = ?    // compile error. Shadow captured x
   result = 200
}
const f2 = comb() -&gt; (result:int) {
   mut x = ?    // OK, no captures &#39;x&#39; variable
   x = 100
   result = x
}
</code></pre></div>
<p>Capture variables pass the value at capture time:</p>
<div class="highlight"><pre><span></span><code>mut x = 3
mut y = 10

const fun2 = fun[y]() -&gt; (result:int) {
  y = 100              // compile error, y is immutable when captured
  mut x = 200
  result = y + x
}
x = 1000
assert fun2() == 203
</code></pre></div>
<h3 id="lambda-arguments">Lambda arguments<a class="headerlink" href="#lambda-arguments" title="Permanent link">&para;</a></h3>
<p>Lambda calls happen whenever an identifer is followed by a list of expressions.
If the first expression in the list has parenthesis, it can lead to unexpected
behavior:</p>
<div class="highlight"><pre><span></span><code>assert 0 == (0)  // OK, same as assert( 0 == (0) )
assert (0) == 0  // compile error: (assert(0)) == 0 is an expression
assert(0 == 0)   // OK
</code></pre></div>
<p>It is also easy to forget that parenthesis can be ommited in simple expressions,
not when ranges or tuples are involed.</p>
<div class="highlight"><pre><span></span><code>assert 2 in (1,2)  // compile error, not allowed to drop parenthesis
assert(2 in (1,2)) // OK
</code></pre></div>
<h3 id="multiple-tuples">Multiple tuples<a class="headerlink" href="#multiple-tuples" title="Permanent link">&para;</a></h3>
<p>The evaluation order is always the same program order starting from the top
module. Remember that the setter method is the constructor called even when
there is no initial value set.</p>
<div class="highlight"><pre><span></span><code>const X_t = (
  i1 = (
    i1_field:u32 = 1,
    i2_field:u32 = 2,
    setter = comb(ref self, a) {
       self.i1_field = a
    }
  ),
  i2 = (
    i1_field:i32 = 11,
    setter = comb(ref self, a) {
       self.i1_field = a
    }
  )
)

mut top = (
  setter = comb(ref self) {
    mut x:X_t = ?
    assert x.i1.i1_field == 1
    assert x.i1.i2_field == 2
    assert x.i2.i1_field == 11

    x.i1 = 400

    assert x.i1.i1_field == 400
    assert x.i1.i2_field == 2
    assert x.i2.i1_field == 11

    x.i2 = 1000

    assert x.i1.i1_field == 400
    assert x.i1.i2_field == 2
    assert x.i2.i1_field == 1000
  }
)
</code></pre></div>
<p>If a lambda in the hierarchy does not have a setter/constructor, the program order
follows the tuple scope which is in tuple ordered asignment.</p>
<h3 id="unknowns">Unknowns<a class="headerlink" href="#unknowns" title="Permanent link">&para;</a></h3>
<p>Pyrope respects the same semantics as Verilog with unknowns. As such, there can
be many unexpected behaviors in these cases. The difference is that in Pyrope
everything is initialized and unknowns (<code>0sb?</code>) can happen only when explicitly
enabled.</p>
<p>The compare respects Verilog semantics. This means that it is true if and only
if all the possible values are true, which is quite counter-intuitive behavior
for programmers not used to 4 value logic.</p>
<div class="highlight"><pre><span></span><code>assert !(0sb? == 0)
assert !(0sb? != 0)
assert !(0sb? == 0sb?)
assert !(0sb? != 0sb?)
</code></pre></div>
<p>There is no way to know at run-time if a value is unknown, but a compile trick
can work. The reason is that integers can be converted to strings in a C++ API</p>
<div class="highlight"><pre><span></span><code>mut x = 0sb10?
const str = __to_string(x) // only works for compile time constants
assert x == &quot;0sb10?&quot;
</code></pre></div>
<h3 id="for-loop">for loop<a class="headerlink" href="#for-loop" title="Permanent link">&para;</a></h3>
<p>The <code>for</code> expects a tuple, and iterates over the tuple. This can lead to some
unexpected behaviour. The most strange is that ranges are always from smallest
to largest. It is not legal to do a <code>5..&lt;0</code> range, the solution is to use a
<code>to</code> which creates a tuple not a range.</p>
<div class="highlight"><pre><span></span><code>const s:string=&quot;hell&quot;
for (idx,i) in s.enumerate() {
  const v = match idx {
   == 0 { &quot;h&quot; }
   == 1 { &quot;e&quot; }
   == 2 { &quot;l&quot; }
   == 3 { &quot;l&quot; }
  }
  assert v == i
}

const t = (1,2,3)
for (idx,i) in t.enumerate() {
  const v = match idx {
   == 0 { 1 }
   == 1 { 2 }
   == 2 { 3 }
  }
  assert v == i
}

const r=2..&lt;5
for (idx,i) in r.enumerate() {
  const v = match idx {
   == 0 { 2 }
   == 1 { 3 }
   == 2 { 4 }
  }
  assert v == i
}

const r2=4..=2 step -1
assert r2 == (4,3,2)
for (idx,i) in r2.enumerate() {
  const v = match idx {
   == 0 { 4 }
   == 1 { 3 }
   == 2 { 2 }
  }
  assert v == r2[i]
}

for i in 2..&lt;5 {
  const ri = 2+(4-i) // reverse index
  // 2 == (2..&lt;5).trailing_one
  // 4 == (2..&lt;5).leading_one
  const v = match idx {
   == 0 { 4 }
   == 1 { 3 }
   == 2 { 2 }
  }
  assert v == ri
}

for (idx,i) in enumerate(123) {
  assert i == 123 and idx==0
}
</code></pre></div>
<h3 id="multiple-bit-selection">Multiple bit selection<a class="headerlink" href="#multiple-bit-selection" title="Permanent link">&para;</a></h3>
<p>Ranges are sets, this creates potentially unexpected results in reverse <code>for</code>
iterators, but also in bit section:</p>
<div class="highlight"><pre><span></span><code>const v = 0xF0

assert v#[0] == 0
assert v#[4] == 1       // unsigned output
assert v#sext[4] == -1  // signed output

assert v#[3..=4] == 0b010 == v#[3,4]
assert v#[4..=3 step -1] == 0b010
assert v#[4,3] == v#[3,4] == 0b010

const tmp1 = (v#[4], v#[3])#[..]  // typecast from
const tmp2 = (v#[3], v#[4])#[..]
const tmp3 = v#[3,4]
assert tmp1 == 0b01
assert tmp2 == 0b100
assert tmp3 == 0b10

const tmp1s = (v#sext[4], v#sext[3])#[..]  // typecast from
const tmp2s = (v#sext[3], v#sext[4])#[..]
const tmp3s = v#[4,3]
assert tmp1s == 0b01
assert tmp2s == 0b10
assert tmp3s == 0b10

const tmp1ss = (v#sext[4], v#sext[3])#sext[..]  // typecast from
const tmp2ss = (v#sext[3], v#sext[4])#sext[..]
const tmp3ss = v#sext[3,4]
assert tmp1ss == 0b01  ==  1
assert tmp2ss == 0sb10 == -2
assert tmp3ss == 0sb10 == -2 == v#sext[4,3]
</code></pre></div>
<p>The reason is that for multiple bit selection assumes a smaller to larger bits.
If the opposite order is needed, support functions/code must explicitly do it.</p>
<p>In Pyrope, there is no order in bit selection (<code>xx#[0,1,2,3] == xx#[3,2,1,0]</code>) even when bit slicing.
This is different from Verilog when endianness in declaration only happens when bit slicing.
This is done to avoid mistakes. If a bit swap is wanted, it must be explicit.</p>
<div class="highlight"><pre><span></span><code>const reverse = comb(x:uint) -&gt; (total:uint) {
  total = 0
  for i in 0..&lt;x::[bits] {
    total &lt;&lt;= 1
    total |= x#[i]
  }
}
assert reverse(0b10110) == 0b01101
</code></pre></div>
<h3 id="unexpected-calls">Unexpected calls<a class="headerlink" href="#unexpected-calls" title="Permanent link">&para;</a></h3>
<p>Passing a lambda argument with a <code>ref</code> does not have any side effect because
lambdas without arguments need to be explicitly called or just passed as
reference.</p>
<div class="highlight"><pre><span></span><code>const args = comb(x) { puts &quot;args:{x}&quot;; 1 }
const here = comb() { puts &quot;here&quot;; 3 }

const call_now = comb(f:fun) { f() }
const call_defer = comb(f:fun) { f }

const x0 = call_now(here)          // prints &quot;here&quot;
const e1 = call_now(args)          // compile error, args needs arguments
const x1 = call_defer(here)        // nothing printed
const e2 = call_defer(args)        // compile error, args needs arguments
assert x0  == 3                  // nothing printed
assert x1  == 3                  // nothing printed

const x2 = call_now(ref here)      // prints &quot;here&quot;
const e3 = call_now(ref args)      // compile error, args needs arguments
const x3 = call_defer(ref here)    // nothing printed
const x4 = call_defer(ref args)    // nothing printed
assert x2  == 3                  // nothing printed
assert x3()  == 3                // prints &quot;here&quot;
assert x3  == 3                  // compile error, explicit call needed
assert x4  == 1                  // compile error, args needs arguments
assert x4(&quot;xx&quot;) == 1             // prints &quot;args:xx&quot;
</code></pre></div>
<h3 id="if-is-an-expression"><code>if</code> is an expression<a class="headerlink" href="#if-is-an-expression" title="Permanent link">&para;</a></h3>
<p>Since <code>if</code>, <code>for</code>, <code>match</code> are expressions, you can build some strange code:</p>
<div class="highlight"><pre><span></span><code>if if x == 3 { true }else{ false } {
  puts &quot;x is 3&quot;
}
</code></pre></div>
<h3 id="legal-but-weird">Legal but weird<a class="headerlink" href="#legal-but-weird" title="Permanent link">&para;</a></h3>
<p>There is no <code>--</code> operator in Pyrope, but there is a <code>-</code> which can
be followed by a negative number <code>-3</code>.</p>
<div class="highlight"><pre><span></span><code>const v = (3)--3
assert v == 6
</code></pre></div>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Narrowing is based on "ABCD: eliminating array bounds checks on-demand"
  by Ras Bodik et al.&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["search.suggest", "navigation.sections", "navigation.instant", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>