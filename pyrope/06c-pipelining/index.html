
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../06b-instantiation/">
      
      
        <link rel="next" href="../07-typesystem/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.3, mkdocs-material-9.1.15">
    
    
      
        <title>Pipelining - LiveHD and Pyrope</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.26e3688c.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ecc896b0.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/table.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#pipelining" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="LiveHD and Pyrope" class="md-header__button md-logo" aria-label="LiveHD and Pyrope" data-md-component="logo">
      
  <img src="../../assets/pyrope5.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LiveHD and Pyrope
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pipelining
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
            
              <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
              </label>
            
          
            
            
            
            <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
            
              <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
              </label>
            
          
        </form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/masc-ucsc/livehd" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LiveHD and Pyrope" class="md-nav__button md-logo" aria-label="LiveHD and Pyrope" data-md-component="logo">
      
  <img src="../../assets/pyrope5.png" alt="logo">

    </a>
    LiveHD and Pyrope
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/masc-ucsc/livehd" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        LiveHD and Pyrope
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          Livehd
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Livehd
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/00-intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/01-install/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/02-usage/" class="md-nav__link">
        Usage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/03-memory/" class="md-nav__link">
        Memory and concurrency
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/04-api/" class="md-nav__link">
        C++ API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/05-lgraph/" class="md-nav__link">
        LGraph
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/06-lnast/" class="md-nav__link">
        LNAST
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/10-bazel/" class="md-nav__link">
        Bazel build
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/10b-3rdparty/" class="md-nav__link">
        3rd Party
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/11-pass/" class="md-nav__link">
        Creating a Pass
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/12-github/" class="md-nav__link">
        GitHub Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../livehd/13-style/" class="md-nav__link">
        Coding Style
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Pyrope
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Pyrope
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../00-hwdesign/" class="md-nav__link">
        Hardware Design
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../01-introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../02-basics/" class="md-nav__link">
        Basic syntax
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../03-bundle/" class="md-nav__link">
        Tuples
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../04-variables/" class="md-nav__link">
        Variables and types
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05-assert/" class="md-nav__link">
        Verification
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../05b-statements/" class="md-nav__link">
        Statements
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06-functions/" class="md-nav__link">
        Lambdas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../06b-instantiation/" class="md-nav__link">
        Instantiation
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pipelining
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Pipelining
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#registers" class="md-nav__link">
    Registers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipestage" class="md-nav__link">
    Pipestage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipestage-with-loops" class="md-nav__link">
    Pipestage with loops
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retiming" class="md-nav__link">
    Retiming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiply-add-example" class="md-nav__link">
    Multiply-Add example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alu-example" class="md-nav__link">
    ALU example
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../07-typesystem/" class="md-nav__link">
        Type system
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../07b-structtype/" class="md-nav__link">
        Structural Typing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../08-memories/" class="md-nav__link">
        Memories
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../09-stdlib/" class="md-nav__link">
        Pyrope std lib
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../10-internals/" class="md-nav__link">
        Internals
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../10b-vslang/" class="md-nav__link">
        vs Other Languages
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../11-deprecated/" class="md-nav__link">
        Deprecated or Future
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../12-lnast/" class="md-nav__link">
        LNAST
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../13-stdlib/" class="md-nav__link">
        Pyrope Standard Library
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#registers" class="md-nav__link">
    Registers
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipestage" class="md-nav__link">
    Pipestage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pipestage-with-loops" class="md-nav__link">
    Pipestage with loops
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retiming" class="md-nav__link">
    Retiming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#multiply-add-example" class="md-nav__link">
    Multiply-Add example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#alu-example" class="md-nav__link">
    ALU example
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="pipelining">Pipelining<a class="headerlink" href="#pipelining" title="Permanent link">&para;</a></h1>
<h2 id="registers">Registers<a class="headerlink" href="#registers" title="Permanent link">&para;</a></h2>
<p>Together with memories, flip-flops or latches are the basic constructs used by
hardware to store information and to build pipeline stages. Pyrope's goal is to
be a zero-cost overhead, and as such it allows to handle flops directly.</p>
<p>To create an individual flop, a direct RTL instantiation of a <code>__flop</code> can be
used. Flops and latches have several pins <code>din</code>, <code>q</code>, <code>clock</code>, <code>enable</code> and
configuration options <code>posclk</code>, <code>initial</code>, and <code>async</code>. </p>
<p>A more programmer-friendly is to use to declare a register. The compiler does
not provide guarantees that the register will not be split into multiple
registers.</p>
<p>The explicit connection likely requires constructs like <code>.[defer]</code> to connect
the flop <code>q</code> pin.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Structural flop style</label><label for="__tabbed_1_2">Pyrope style</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>var counter_next:u8:[wrap] = _

let counter_q = __flop(din=counter_next.[defer] // defer to get last update
                   ,reset_pin=my_rst, clock_pin=my_clk
                   ,enable=my_enable            // enable control
                   ,posclk=true
                   ,initial=3                   // reset value
                   ,async=false)

counter_next = counter_q + 1
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>reg counter:u8:[reset_pin=my_rst, clock_pin=my_clk, posclk=true]= 3
assert counter == counter#[0]  // counter still has the q value

if my_enable {
  counter::[wrap] = counter + 1
}
</code></pre></div>
</div>
</div>
</div>
<p>Flops have <code>din</code> and a <code>q</code> pin. At the beginning of the cycle both <code>din</code> and
<code>q</code> have the same value, but as the <code>din</code> is updated with "next cycle" <code>q</code>
value their contents may be different. Different HDLs have different syntax to
distinguish between <code>din</code> and <code>q</code> pin. In Verilog, it is common to have a
coding style guideline that gives a different name to the din variables than to
the q variables (E.g: <code>counter_q</code> vs <code>counter_next</code>). The structural flop style
is a legal Pyrope code using these type of names.</p>
<p>In a more friendly Pyrope style, a register like <code>counter</code> starts with the <code>q</code>
pin each cycle. The last value written to <code>counter</code> connects to the <code>din</code>. It
is always possible to access the <code>q</code> pin/value directly with  pipeline
directives <code>something#[0]</code>.</p>
<p>If the register is accessed with the <code>-1</code> cycle (<code>#something#[-1]</code>), the flop will
insert an additional pipeline to access 1 cycle before flop contents.</p>
<p>It is also possible to use positive values (<code>variable#[3]</code>) which means the
value in the future 3 cycles, but this is only allowed in debug statements like
<code>assert</code> or <code>puts</code>.</p>
<p>Latches are possible but with the direct RTL instantiation. Latches have 
a <code>din</code> and <code>enable</code> pin like a flop, but just one option <code>posclk</code>.</p>
<div class="highlight"><pre><span></span><code>var my_latch_q = __latch(din=my_din, enable=my_enable, posclk=true)
</code></pre></div>
<h2 id="pipestage">Pipestage<a class="headerlink" href="#pipestage" title="Permanent link">&para;</a></h2>
<p>Pyrope has a <code>pipestage</code> statement (<code>#&gt;identifier[fsm_configuration]</code>) that
helps to create simple pipeline stages. The <code>identifier[fsm_configuration]</code> is
optional and the default meaning is a fully pipelined 1 pipeline stage depth.
It is the same as saying <code>_[lat=1]</code>. The identifier can be accessed as an
attribute to count the pipestage utilization.</p>
<p>The fsm configuration can have <code>lat</code> (number of pipeline stages or latency) or
<code>num</code> (number of units). The number of units is only needed when the code is
not fully pipelined in combination with loop constructs like <code>while</code>, <code>for</code>,
and <code>loop</code>.</p>
<p>The <code>num</code> sets the number of units. The hardware will not back pressure, but an
assertion will fail during simulation if the number of units is overflowed.
<code>num</code> only makes sense when the latency (<code>lat</code>) is more than 1.</p>
<div class="highlight"><pre><span></span><code>// variables/register before

{
  // stage 0 scope
} #&gt; {               // no identifier, 1 stage by default
  // stage 1 scope
} #&gt;foo[2] {            // no identifier, 2 stages
  // stage 2-3 scope
} #&gt;bar[1] {     // &#39;free_stage&#39; identifier, 1 stages
  // stage 4 scope
} #&gt; {
  // stage 5 scope
}

// variables/register after pipestage
</code></pre></div>
<p>The semantics of <code>pipestage</code> are as follows:</p>
<ul>
<li>
<p>Explicitly declared registers (<code>reg foo</code>) are not affected by <code>pipestage</code></p>
</li>
<li>
<p>Variables declared before are "pipelined" inside each of the <code>pipestage</code> scopes.</p>
</li>
<li>
<p>Variables declared in a stage are pipelined to all the following stages
  unless the variable is private (<code>var priv_example::[private]=3</code>)</p>
</li>
<li>
<p>The pipelined variables are not visible in the scope after the <code>pipestage</code>
  sequence.</p>
</li>
<li>
<p>The original non-pipelined variable can be accessed with <code>v#[0]</code>.</p>
</li>
</ul>
<p>To illustrate the semantics, imagine a module where the input <code>i</code> is a
monotonically increasing sequence (<code>0,1,2,3,4,5,6,7....</code>).</p>
<div class="highlight"><pre><span></span><code>assert i==0 or (i#[-1] + 1 == i)

let i_let = i

var i_var0 = i
var i_var1 = i

reg i_reg0 = i        // initialization only
reg i_reg1:i_reg0 = _

i_reg1 = i                // every cycle

{
  assert i == i#[0]       // i#[0] is unflop input (or first defined) value
  assert i == i_let
  assert i == i_var0
  assert i == i_var1

  assert 0 == i_reg0
  assert i == i_reg1

  let _local_var = 3

  let pub_var = 100 + i

} #&gt; {
  assert _local_var!=0      // compile error, _local_var is not in scope
  assert pub_var == 100 + i // pipelined pub_var

  // both inputs and variables flop, so asserts hold
  assert i == i_let
  assert i == i_var0
  assert i == i_var1

  assert 0 == i_reg0        // i_reg0 never changes, so 0 is fine
  assert i#[-1] == i_reg1   // last i-reg, not current

  assert i == 0 or (i == i#[0]+1)  // i#[0] is the unflop original
}

assert pub_var != 0 // compile error, pub_var is not in scope
</code></pre></div>
<p>The pipestage accept the <code>clock</code> and <code>posclk</code> attributes from register to allow
the selection of different clock signal. Notice that it does not allow <code>reset</code>
or <code>latch</code> or <code>async</code> because it does not require reset logic.</p>
<p>Pipelining is one of the challenges of designing hardware. Even a simple pipestage
code can result in incorrect hardware. The reason is that if two pipestage blocks
generate an output simultaneously, there is no way to generate both outputs. The
result is a compile or simulation error.</p>
<div class="highlight"><pre><span></span><code>let bad_code = proc(my_clk, inp)-&gt;(o1,o2) {

  {
    o1 = 1
    o2 = inp + 1  // o2? iff bad_code called this cycle and inp? is valid
  } #&gt;my_pipe[lat=1,clock=my_clk] {
    o1 = 2        // compile error, o1 driven simultaneous from multiple stages
    o2 = inp + 2  // may be OK if inp is not valid every cycle
  }

}
</code></pre></div>
<h2 id="pipestage-with-loops">Pipestage with loops<a class="headerlink" href="#pipestage-with-loops" title="Permanent link">&para;</a></h2>
<p>The pipestage directive (<code>#&gt;identifier[cycles]{  }</code>) automatically creates a fully
pipeline design with <code>cycles</code> pipeline depth. <code>cycles</code> must be bigger or equal
than 1 and known at compile time. When <code>cycles</code> is not specified a <code>1</code> value is
assumed.</p>
<p>Pipestage can be applied to <code>while</code> and <code>loop</code> statements, not to <code>for</code>
statements because <code>for</code> must be fully unrolled at compile time.</p>
<p>When applied to loops, the loop becames a state machine with <code>cycles</code> the
maximum number of simultaneous loop iterations. It effectively means that
number of units or state machines that can perform the loop simultaneously.
The identifier becomes a procedure attribute.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:5"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><input id="__tabbed_2_4" name="__tabbed_2" type="radio" /><input id="__tabbed_2_5" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Fully Pipelined</label><label for="__tabbed_2_2">State-machine</label><label for="__tabbed_2_3">Slow 1 Stage</label><label for="__tabbed_2_4">Slow 1 Stage (alt syntax)</label><label for="__tabbed_2_5">Pure Combinatinal</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>let mul3=proc(a,b)-&gt;res {
  let tmp = a*b
  #&gt;full_case[lat=3,num=3] { // Same as full_case[lat=3]
    res = tmp
  }
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>let mul_slow=proc(a,b)-&gt;res {

  let result  = 0
  let rest    = a

  while rest &gt;= b #&gt;_[lat=1,num=4] {  // lat=1 is latency per iteration
    rest = rest - b
    result += 1
  }

  res = result
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>let mul1=proc(a,b)-&gt;(reg res) {
  res = a*b
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>let mul1=proc(a,b)-&gt;(res) {
  #&gt;full_case_again[lat=1] { 
    res = a*b
  }
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>let mul0=proc(a,b)-&gt;(res) {
  res = a*b
}
</code></pre></div>
</div>
</div>
</div>
<p>To understand the fully pipelined behavior, the following shows the pipestage
against the more direct implementation with registers.</p>
<div class="highlight"><pre><span></span><code>if cond {
  var p1 = inp1
  var out = _

  {
    var _l1 = inp1 + 1

    var p2 = inp1 + 2
  } #&gt; {
    out = p1 + p2
  }

  res = out
}

// Non pipestage equivalent
if cond {
  var p1 = inp1
  var out = _

  {
    reg p1r = _
    reg p2r = _

    var l1::[private] = inp1 + 1  // private
    var p2 = inp1 + 2             // public

    out = p1r + p2r               // registered values

    p1r = p1
    p2r = p2
  }

  res = out
}
</code></pre></div>
<h2 id="retiming">Retiming<a class="headerlink" href="#retiming" title="Permanent link">&para;</a></h2>
<p>The registers manually inserted with the <code>reg</code> directive are preserved
and annotated so that synthesis retiming can not change them. This means
that by default register can not be duplicated or logic can move around.</p>
<p>A register can be marked with the <code>retime</code> flag, in which case the synthesis
tools are allowed to perform the following optimizations:</p>
<ul>
<li>
<p>Retime or move logic across which effectively changes the meaning of the register.</p>
</li>
<li>
<p>Duplication is allowed when frequency improvements grant it.</p>
</li>
<li>
<p>Elimination. If there are no reads or no writes, the register can be remove
  and replaced with a constant (no writes) or just removed (no reads).</p>
</li>
<li>
<p>Copy propagation is allowed across registers. This is not possible without
  retime because the scan chain could reconfigure the flop.</p>
</li>
</ul>
<p>The registers automatically inserted with the <code>pipestage</code> command are marked
with <code>retime</code> true. Additionally, retime can be set in any register:</p>
<div class="highlight"><pre><span></span><code>reg my_reg::[retime=true,clock=my_clk] = 0
</code></pre></div>
<h2 id="multiply-add-example">Multiply-Add example<a class="headerlink" href="#multiply-add-example" title="Permanent link">&para;</a></h2>
<p>To illustrate the confusion/complication the following example illustrates a
multiplier that takes 3 cycles and an adder that takes 1 cycle to complete, and
the conceptual problems of integrating them:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Pipestage</label><label for="__tabbed_3_2">Explicit Stages</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>let block = proc(in1,in2)-&gt;(out) {
  {
    let tmp = in1 * in2
  } #&gt;some_id[lat=3] {
    out = tmp + in1#[0]
  }
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>add1 = proc(a,b) {     // 1 cycle add
  reg r  = _
  let rr = r           // get flop value
  r = a+b
  return rr
}
let mul3 = proc(a,b) { // 3 cycle multiply
  reg reg1 = _
  reg reg2 = _
  reg reg3 = _
  reg3 = reg2
  reg2 = reg1
  reg1 = a * b
  return reg3
}

let block = proc(in1,in2)-&gt;(out) {
  let x =#[..] mul3(in1, in2)
  out   =#[..] add1(x,in3)
}
</code></pre></div>
</div>
</div>
</div>
<p>In general, <code>#</code> is used when dealing with registers. The previous example use
<code>procedures</code> (<code>proc ... {...}</code>) instead of <code>functions</code> (<code>fun ... {...}</code>) because functions
only have combinational logic. When the procedures are called, the assigned
variable needs the <code>=#[..]</code>. This is to explicitly indicate to Pyrope that the
function called (<code>mul3</code>, <code>add1</code>) can have pipeline outputs. This helps the tool
but more importantly the programmer because it helps to check assumptions about
the function connections. The typical assignment <code>=</code> only connects
combinational logic.</p>
<p>The previous code connects two inputs (<code>in1</code>/<code>in2</code>) to a multiplier, and then
connects the result of the multiplier to an adder. The inputs are also
passed to the adder. This results in the following functionality:</p>
<div  class="mermaid">graph LR
    in1[in1] --a--> m0(mul3 cycle 0)
    in2[in2] --b--> m0

    m0 --> m1(mul3 cycle 1)
    m1 --> m2(mul3 cycle 2)

    in1--a--> a0[add1 cycle 1]
    m2 --b--> a0
    a0 --> out[out]
</div>
<p>The issue in most HDLs is that the connection is unaware of the pipelining, and
it is left up to the programmer to understand and check the potential pipeline
stages inside <code>add1</code> and <code>mul3</code>. This lack of pipelining awareness in the
language syntax is common in most HDLs.</p>
<p>In Pyrope, the <code>=#[..]</code> must be used when there is any path that starts from the
inputs of the function passes through a pipeline stage to generate the
assignment. If all the paths have exactly 1 flop in between, it is a 1 stage
pipeline, if some paths have 2 flops and others 3, it is a 2 or 3 pipeline
stages. Sometimes, there are loops, and the tool has 1 to infinite pipeline
stages.</p>
<p>The default pipeline assignment <code>=#[..]</code> just checks that it is possible to have
pipeline stages between the module/function inputs and the assignment value. To
restrict the check, it accepts a range. E.g: <code>=#[3]</code> means that there are
exactly 3 flops or cycles between inputs and the assignment. <code>=#[0..&lt;4]</code> means
that there are between 0 and 3 cycles, and open range could be used when there
are loops (E.g: <code>=#[2..]</code>).</p>
<div class="highlight"><pre><span></span><code>let x = mul3(in1, in2)      // compile error: &#39;mul3&#39; is pipelined
let x =#[..] mul3(in1, in2) // OK
out  =#[..] add1(x,in3)     // OK (in3 has 0 cycles, x has 3 cycles)
out  =#[1] add1(x,in3)      // compile error: &#39;x&#39; is pipelined with &#39;3&#39; cycles
out  =#[3] add1(x,in3)      // compile error: &#39;in3&#39; is pipelined with &#39;1&#39; cycle
out  =#[1..&lt;4] add1(x,in3)  // OK
</code></pre></div>
<p>The designer likely wanted to implement a multiply-add. As such,
the input to the adder should be from the same cycle as the multiplied started
to operate. Otherwise, values across cycles are mixed.</p>
<div  class="mermaid">graph LR
  in1[in1] --a--> m0(mul3 cycle 0)
  in2[in2] --b--> m0

  m0 --> m1(mul3 cycle 1)
  m1 --> m2(mul3 cycle 2)

  in1  --> in1_0(flop cycle 0)
  in1_0--> in1_1(flop cycle 1)
  in1_1--> in1_2(flop cycle 2)
  in1_2--a--> a0[add1 cycle 0]
  m2 --b--> a0
  a0 --> out[out]
</div>
<p>It is possible to balance the pipeline stages explicitly, the issue is that it
is error-prone because it requires knowing exactly the number of cycles for
<code>mul3</code>. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Pipestage</label><label for="__tabbed_4_2">Explicitly added pipeline stages</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>{
  let tmp = in1 * in2
} #&gt;fully_pipe[lat=3] {
  out = tmp + in1
}
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>x =#[..] mul3(in1, in2)
y = in1#[-3]
out =#[..] add1(a=x,b=y)    // connect in1 from -3 cycles
</code></pre></div>
</div>
</div>
</div>
<div class="admonition observation">
<p class="admonition-title">Observation</p>
<p>The explicit <code>v#[-cycles]</code> inserts registers and access the result <code>cycles</code>
before. This same syntax can be used with assertions similar to the Verilog
<code>$past(v, cycles)</code>.</p>
</div>
<h2 id="alu-example">ALU example<a class="headerlink" href="#alu-example" title="Permanent link">&para;</a></h2>
<p>Pipestages allow to build fully pipelined structures but also non-pipelined
state machines when applied to loops. This creates potential contention that the
designer must decide how to manage. This contention can be propagated outside
the procedure with attributes.</p>
<p>The ALU example illustrates the contention by creating an ALU with 3 different
pipelines (add,mul,div) that have different latencies and contention.</p>
<div class="highlight"><pre><span></span><code>let quick_log2 = fun(a) {

  cassert a&gt;=1

  var i = 1
  var v = 0
  while i &lt; a.[bits] {
    v |= i
    i *= 2
  }

  return v
}

let div=proc(a,b,id)-&gt;(res,id) {
  loop #&gt;free_div_units[4] {
    return (a &gt;&gt; quick_log2(b), id) when b@+[..] == 1
    #&gt;my_fsm[lat=5,num=1] {
      res = (a/b, id)
    }
  }
}

let mul=proc(a,b,id)-&gt;(res, id) {
  #&gt;pending_counter[lat=3,num=2] {
    res = a*b
    id  = id
  }
}

let add=proc(a,b,id)-&gt;(res,id) {
  #&gt;add_counter[lat=1] {         // Fully pipeline, num not specified
    res = a+b
    id  = id
  }
}

let alu = proc(a,b,op, id)-&gt;(res,id) {

  self.[total_free_units] = 1 
     + mul.[pending_counter] 
     + div.[free_div_units]
     + add.[add_counter]

  self.[div_units] = div.[free_div_units]

  match op {
    == OP.div {
      assert div.[free_div_units]&gt;0
      (res,id) = div(a,b,id)
    }
    == OP.mul { (res,id) = mul(a,b,id) }
    == OP.add { (res,id) = add(a,b,id) }
  }
}

test &quot;alu too many div&quot; {

 cassert alu.[total_free_units] == (1+3+4)

 let r1 = alu(13,3, OP.div, 1)
 assert alu.div_units==3
 let r2 = alu(13,3, OP.div, 2)
 assert alu.div_units==2
 let r3 = alu(13,3, OP.div, 3)
 assert alu.div_units==1
 let r4 = alu(13,3, OP.div, 4)
 assert alu.div_units==0

 assert !r1? and !r2? and !r3? and !r4? // still invalid

 let r5 = alu(13,4, OP.mul,5)
 cassert mul.[pending_counter] == 2
}
</code></pre></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "navigation.sections", "navigation.instant", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b4d07000.min.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>